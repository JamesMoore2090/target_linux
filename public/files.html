<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TARGEX File Manager</title>
    <style>
        body { font-family: monospace; background: #1e1e1e; color: #ccc; padding: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { text-align: left; padding: 10px; border-bottom: 1px solid #444; }
        th { color: #00ff00; }
        .locked { color: #777; font-style: italic; }
        button { padding: 10px 20px; cursor: pointer; background: #333; color: white; border: 1px solid #555; }
        button:hover { background: #444; }
        .actions { margin-bottom: 20px; display: flex; gap: 10px; }

        #processing-modal {
        display: none; /* Hidden by default */
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.8);
        align-items: center;
        justify-content: center;
        flex-direction: column;
    }
    .spinner {
        border: 8px solid #f3f3f3;
        border-top: 8px solid #00ff00; /* Neon Green */
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

        

    <div id="processing-modal">
        <div class="spinner"></div>
        <h2 style="color: #00ff00; font-family: monospace;">PROCESSING DATA...</h2>
        <p style="color: #ccc;">Merging and Converting Files. Please Wait.</p>
    </div>

    <h1>DATA ARCHIVE</h1>
    <div class="actions">
        <button onclick="location.href='/'">‚Üê Back to Live View</button>
        <div style="flex-grow: 1;"></div>
        <select id="export-format">
            <option value="csv">CSV (Excel)</option>
            <option value="json">JSON (Full Data)</option>
        </select>
        <button onclick="processFiles()" style="background: #004400;">MERGE & DOWNLOAD</button>
    </div>

    <table>
        <thead>
            <tr>
                <th>Select</th>
                <th>Filename</th>
                <th>Size (Bytes)</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody id="file-list"></tbody>
    </table>

    <script>
        async function loadFiles() {
            const res = await fetch('/api/files');
            const data = await res.json();
            const tbody = document.getElementById('file-list');
            tbody.innerHTML = '';

            data.files.forEach(file => {
                const tr = document.createElement('tr');
                
                // Checkbox Logic
                // FIX: Changed "file-chk" to "file-checkbox" so the download function can find it!
                let checkbox = `<input type="checkbox" value="${file.name}" class="file-checkbox">`;
                let status = "Ready";
                
                if (file.locked) {
                    checkbox = `<input type="checkbox" disabled>`;
                    status = "<span style='color:orange'>Actively Recording...</span>";
                    tr.className = "locked";
                }

                tr.innerHTML = `
                    <td>${checkbox}</td>
                    <td>${file.name}</td>
                    <td>${file.size.toLocaleString()}</td>
                    <td>${status}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function processFiles() {
            // 1. Get Selected Files
        const checkboxes = document.querySelectorAll('.file-checkbox:checked');
        const files = Array.from(checkboxes).map(cb => cb.value);
        const format = document.getElementById('export-format').value;

        if (files.length === 0) {
            alert("Please select at least one file!");
            return;
        }

        // 2. SHOW MODAL
        const modal = document.getElementById('processing-modal');
        modal.style.display = "flex";

        try {
            // 3. SEND REQUEST (Waits for C++ to finish)
            const res = await fetch('/api/merge', {
                method: 'POST',
                body: JSON.stringify({ files: files, format: format })
            });

            if (!res.ok) throw new Error("Server Error");

            const data = await res.json(); // Get the { url: "/download.csv" } response

            // 4. GENERATE UNIQUE FILENAME
            const now = new Date();
            // Format: TARGEX_Merge_YYYYMMDD_HHMMSS.csv
            const timestamp = now.toISOString().replace(/[-:T]/g, '').split('.')[0]; 
            const uniqueName = `TARGEX_Merge_${timestamp}.${format}`;

            // 5. FORCE DOWNLOAD
            // We create an invisible link and click it
            const link = document.createElement('a');
            link.href = data.url;        // The static file on the server
            link.download = uniqueName;  // The name the user sees
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

        } catch (e) {
            alert("Error processing files: " + e.message);
        } finally {
            // 6. HIDE MODAL
            modal.style.display = "none";
        }
        }

        loadFiles();
    </script>
</body>
</html>