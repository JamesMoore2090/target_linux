<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TARGEX Live Log</title>
    <style>
        /* --- GLOBAL LAYOUT --- */
        body { 
            margin: 0; padding: 0; background: #111; color: #ccc;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            overflow: hidden; display: flex; height: 100vh; 
        }

        /* --- SIDEBAR --- */
        #sidebar {
            width: 300px; min-width: 300px;
            background: #1e1e1e; border-right: 1px solid #333;
            display: flex; flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,0.5); z-index: 1000;
        }
        .sidebar-header {
            padding: 15px; background: #252526; border-bottom: 2px solid #007acc;
        }
        .sidebar-header h2 { margin: 0; color: #00ff00; font-size: 20px; letter-spacing: 1px; }
        .sidebar-header span { font-size: 10px; color: #888; }
        
        .section { padding: 15px; border-bottom: 1px solid #333; }
        .section-title { font-size: 11px; font-weight: bold; color: #007acc; margin-bottom: 10px; text-transform: uppercase; }
        
        .btn-nav { 
            width: 100%; padding: 8px; cursor: pointer; border: none; 
            font-weight: bold; background: #444; color: white; margin-top: 5px;
            text-align: center; text-decoration: none; display: inline-block; box-sizing: border-box;
            font-size: 13px;
        }
        .btn-nav:hover { background: #555; }

        .status-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; }
        .status-val { font-family: monospace; color: #fff; }
        .indicator { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 5px; }
        .green { background: #00ff00; box-shadow: 0 0 5px #00ff00; }
        .red { background: #ff0000; box-shadow: 0 0 5px #ff0000; }

        /* --- MAIN CONTENT AREA --- */
        #main-content {
            flex-grow: 1; padding: 20px; display: flex; flex-direction: column; background: #111;
        }

        h1 { color: #00ff00; margin-top: 0; font-family: monospace; border-bottom: 1px solid #333; padding-bottom: 10px; }

        /* Controls Bar */
        .actions { 
            display: flex; gap: 10px; margin-bottom: 10px; 
            align-items: center;
        }
        .btn-action {
            background: #333; color: white; border: 1px solid #555; padding: 8px 15px; cursor: pointer;
            font-family: monospace; font-size: 12px;
        }
        .btn-action:hover { background: #444; }
        .btn-clear { background: #500; border: 1px solid #700; }

        /* Log Terminal */
        #log-container {
            flex-grow: 1; background: #000; border: 1px solid #333;
            overflow-y: auto; padding: 10px; font-family: 'Consolas', 'Courier New', monospace;
            font-size: 12px; line-height: 1.4;
        }

        .log-entry { margin-bottom: 2px; border-bottom: 1px solid #222; padding: 2px 0; }
        .ts { color: #888; margin-right: 10px; }
        .cat { color: #007acc; font-weight: bold; margin-right: 10px; }
        .json { color: #ccc; word-break: break-all; }
        .key { color: #9cdcfe; }
        .str { color: #ce9178; }
        .num { color: #b5cea8; }

    </style>
</head>
<body>

    <div id="sidebar">
        <div class="sidebar-header">
            <h2>TARGEX</h2>
            <span>LIVE LOGGING SYSTEM</span>
        </div>

        <div class="section">
            <div class="section-title">Stream Status</div>
            <div class="status-row">
                <span>WebSocket</span>
                <span class="status-val"><span id="ws-ind" class="indicator red"></span><span id="ws-text">Offline</span></span>
            </div>
            <div class="status-row">
                <span>Packets Rx</span>
                <span class="status-val" id="pkt-count" style="color: #00ff00;">0</span>
            </div>
        </div>

        <div class="section" style="border:none;">
            <div class="section-title">Navigation</div>
            <a href="/" class="btn-nav">TACTICAL MAP</a>
            <a href="/files" class="btn-nav">FILE MANAGER</a>
        </div>
    </div>

    <div id="main-content">
        <h1>LIVE DATA STREAM</h1>

        <div class="actions">
            <button class="btn-action" onclick="togglePause()" id="btn-pause">PAUSE STREAM</button>
            <button class="btn-action btn-clear" onclick="clearLog()">CLEAR LOG</button>
            <div style="flex-grow: 1;"></div>
            <label style="font-size: 12px; color: #888;"><input type="checkbox" id="chk-autoscroll" checked> Auto-Scroll</label>
        </div>

        <div id="log-container">
            <div style="color: #666; font-style: italic;">Waiting for packets...</div>
        </div>
    </div>

    <script>
        // --- UI REFS ---
        const logContainer = document.getElementById('log-container');
        const wsInd = document.getElementById('ws-ind');
        const wsText = document.getElementById('ws-text');
        const pktCountEl = document.getElementById('pkt-count');
        const btnPause = document.getElementById('btn-pause');
        const chkScroll = document.getElementById('chk-autoscroll');

        let pktCounter = 0;
        let isPaused = false;
        const MAX_LOG_LINES = 500; // Prevent browser lag

        // --- WEBSOCKET ---
        const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
        const socket = new WebSocket(`${protocol}://${window.location.host}/ws`);

        socket.onopen = () => {
            wsInd.className = "indicator green";
            wsText.textContent = "Online";
        };

        socket.onclose = () => {
            wsInd.className = "indicator red";
            wsText.textContent = "Disconnected";
        };

        socket.onmessage = (event) => {
            pktCounter++;
            pktCountEl.textContent = pktCounter.toLocaleString();

            if (!isPaused) {
                try {
                    const packet = JSON.parse(event.data);
                    appendLog(packet);
                } catch (e) { console.error(e); }
            }
        };

        // --- LOG LOGIC ---
        function appendLog(packet) {
            // Format Timestamp
            const now = new Date();
            const timeStr = now.toLocaleTimeString() + "." + String(now.getMilliseconds()).padStart(3, '0');

            // Identify Packet Type
            let type = "UNK";
            let details = "";
            
            if (packet.layers && packet.layers.asterix) {
                const ast = packet.layers.asterix;
                // Try to find Category
                if (ast.asterix_asterix_category) type = "CAT " + ast.asterix_asterix_category;
                else if (ast.asterix_category) type = "CAT " + ast.asterix_category;
                else type = "ASTERIX";

                // Quick Summary (Track ID)
                let tid = ast.asterix_asterix_048_161_TN || ast.asterix_048_161_TN || 
                          ast.asterix_asterix_034_161_TN || ast.asterix_034_161_TN;
                if (tid) details = `Track: ${Array.isArray(tid) ? tid[0] : tid}`;
            }

            // Create Element
            const div = document.createElement('div');
            div.className = 'log-entry';
            
            // Syntax Highlight JSON
            const jsonStr = JSON.stringify(packet).replace(/"([^"]+)":/g, '<span class="key">"$1":</span>')
                                                  .replace(/: "([^"]+)"/g, ': <span class="str">"$1"</span>')
                                                  .replace(/: ([0-9.]+)/g, ': <span class="num">$1</span>');

            div.innerHTML = `
                <span class="ts">[${timeStr}]</span>
                <span class="cat">${type}</span>
                <span style="color: #ccc; margin-right: 10px;">${details}</span>
                <span class="json">${jsonStr}</span>
            `;

            logContainer.appendChild(div);

            // Cleanup old lines
            while (logContainer.children.length > MAX_LOG_LINES) {
                logContainer.removeChild(logContainer.firstChild);
            }

            // Auto Scroll
            if (chkScroll.checked) {
                logContainer.scrollTop = logContainer.scrollHeight;
            }
        }

        // --- CONTROLS ---
        function togglePause() {
            isPaused = !isPaused;
            btnPause.textContent = isPaused ? "RESUME STREAM" : "PAUSE STREAM";
            btnPause.style.background = isPaused ? "#555" : "#333";
            btnPause.style.color = isPaused ? "#ffaa00" : "white";
        }

        function clearLog() {
            logContainer.innerHTML = "";
        }
    </script>
</body>
</html>