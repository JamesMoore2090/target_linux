<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TARGEX Live View</title>
    <style>
        /* CSS: Dark Mode "Matrix" Style */
        body { font-family: 'Courier New', monospace; background: #1e1e1e; color: #00ff00; padding: 20px; margin: 0; }
        
        /* Header Container */
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            border-bottom: 2px solid #333;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }

        h1 { margin: 0; font-size: 24px; color: #fff; }

        /* Controls */
        .controls { display: flex; gap: 15px; align-items: center; }
        
        button { 
            cursor: pointer; 
            padding: 8px 16px; 
            font-weight: bold; 
            border: 1px solid #555;
            background: #333; 
            color: #fff;
            transition: all 0.2s;
        }
        button:hover { background: #444; }

        /* Status Light */
        #status-indicator {
            width: 15px; 
            height: 15px; 
            border-radius: 50%; 
            background: #444; /* Default off */
            border: 2px solid #222;
        }

        /* Packet Log Window */
        #packet-log { 
            height: 80vh; 
            overflow-y: scroll; 
            border: 1px solid #444; 
            padding: 10px; 
            background: #000; 
            font-size: 14px;
        }
        
        /* Individual Log Lines */
        .packet { border-bottom: 1px solid #333; padding: 2px 0; display: flex; }
        .ts { color: #888; margin-right: 10px; width: 140px; flex-shrink: 0; }
        .data { color: #0f0; }
    </style>
</head>
<body>

    <div class="header">
        <h1>TARGEX TACTICAL INTERFACE</h1>
        
        <div class="controls">
            <div id="status-indicator" title="Capture Status"></div>
            
            <button id="toggle-btn" onclick="toggleCapture()">Initializing...</button>
            
            <button onclick="location.href='/files.html'">File Manager</button>
            <button onclick="location.href='/settings.html'">Settings</button>
        </div>
    </div>

    <div id="packet-log">
        <div class="packet"><span class="ts">[SYSTEM]</span><span class="data">Waiting for data stream...</span></div>
    </div>

    <script>
        const logDiv = document.getElementById('packet-log');
        const socket = new WebSocket("ws://" + window.location.host + "/ws");

        socket.onopen = () => {
            console.log("System: Connected");
            addLog("SYSTEM", "Connected to TARGEX Core.");
        };

        socket.onmessage = (event) => {
            try {
                const packet = JSON.parse(event.data);
                
                // 1. FILTER: Ignore Tshark metadata (lines starting with "index")
                if (packet.index) return;

                // 2. DYNAMIC FORMATTING
                let summary = "";
                
                // Case A: Your current flattened format (destination, info, etc.)
                if (packet.destination) {
                    // Try to find source if it exists, otherwise just show destination
                    const src = packet.source || "Unknown"; 
                    const dst = packet.destination;
                    const len = packet.length || "?";
                    const info = packet.info || "";
                    
                    summary = `SRC: ${src} -> DST: ${dst} | Len: ${len} | ${info}`;
                }
                // Case B: Standard Tshark "EK" format (Nested Layers)
                else if (packet.layers && packet.layers.ip) {
                    const src = packet.layers.ip.ip_ip_src;
                    const dst = packet.layers.ip.ip_ip_dst;
                    const len = packet.layers.udp ? packet.layers.udp.udp_udp_length : "TCP";
                    summary = `SRC: ${src} -> DST: ${dst} | Len: ${len}`;
                }
                // Case C: Fallback (Just dump the raw text so you see SOMETHING)
                else {
                    summary = "RAW: " + JSON.stringify(packet).substring(0, 80) + "...";
                }

                // 3. Highlight ASTERIX Data
                if (summary.includes("ASTERIX") || (packet.layers && packet.layers.asterix)) {
                    addLog("ASTERIX", summary, "color: #00ffff;"); // Cyan for special data
                } else {
                    addLog("RX", summary);
                }

            } catch(e) {
                console.error("Parse error:", e);
            }
        };

        socket.onclose = () => {
            console.log("Connection lost.");
            // Optional: Auto-reconnect logic could go here
        };

        function addLog(source, text, style = "") {
            const div = document.createElement('div');
            div.className = 'packet';
            const time = new Date().toLocaleTimeString();
            
            // Allow custom styles (like color) for specific rows
            div.innerHTML = `
                <span class="ts">[${time}] ${source}</span>
                <span class="data" style="${style}">${text}</span>
            `;
            
            logDiv.appendChild(div);
            
            // Auto-scroll to bottom
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        // --- Status Loop (Keep your existing updateStatus logic here) ---
        async function updateStatus() {
            try {
                const res = await fetch('/api/capture/status');
                const data = await res.json();
                const btn = document.getElementById('toggle-btn');
                const ind = document.getElementById('status-indicator');

                if (data.running) {
                    btn.textContent = "STOP CAPTURE";
                    btn.style.background = "darkred";
                    ind.style.background = "#00ff00"; 
                    ind.style.boxShadow = "0 0 10px #00ff00";
                } else {
                    btn.textContent = "START CAPTURE";
                    btn.style.background = "darkgreen";
                    ind.style.background = "red"; 
                    ind.style.boxShadow = "none";
                }
            } catch(e) {}
        }

        async function toggleCapture() {
            const btn = document.getElementById('toggle-btn');
            const isRunning = btn.textContent.includes("STOP");
            await fetch('/api/capture/control', {
                method: 'POST',
                body: JSON.stringify({ action: !isRunning })
            });
            setTimeout(updateStatus, 500);
        }

        setInterval(updateStatus, 2000);
        updateStatus();
    </script>
</body>
</html>