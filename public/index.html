<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TARGEX Tactical Display</title>
    
    <link rel="stylesheet" href="/libs/leaflet.css" />
    <script src="/libs/leaflet.js"></script>
    <script src="/libs/milsymbol.js"></script>

    <style>
        body { 
            margin: 0; padding: 0; background: #111; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            overflow: hidden; display: flex; height: 100vh; 
        }
        
        /* SIDEBARS */
        .sidebar { background: #1e1e1e; border-color: #333; color: #ccc; display: flex; flex-direction: column; z-index: 1000; }
        #sidebar-left { width: 340px; min-width: 340px; border-right: 1px solid #333; overflow-y: auto; } 
        #map { flex-grow: 1; height: 100%; background: #000; z-index: 1; }

        /* WIDGETS */
        .sidebar-header { padding: 15px; background: #252526; border-bottom: 2px solid #007acc; }
        .sidebar-header h2 { margin: 0; color: #00ff00; font-size: 20px; letter-spacing: 1px; }
        .sidebar-header span { font-size: 10px; color: #888; text-transform: uppercase; }
        
        .section { padding: 12px 15px; border-bottom: 1px solid #333; }
        .section-title { font-size: 11px; font-weight: bold; color: #007acc; margin-bottom: 8px; text-transform: uppercase; }
        .divider-title { margin-top: 15px; padding-top: 10px; border-top: 1px solid #333; font-size: 11px; font-weight: bold; color: #007acc; text-transform: uppercase; margin-bottom: 8px; }

        .status-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 13px; }
        .status-val { font-family: monospace; color: #fff; }
        .indicator { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 5px; }
        .green { background: #00ff00; box-shadow: 0 0 5px #00ff00; }
        .red { background: #ff0000; box-shadow: 0 0 5px #ff0000; }
        
        .input-group { margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; }
        .input-group label { font-size: 11px; color: #888; flex-grow: 1; }
        .input-group input, .input-group select { width: 140px; background: #333; border: 1px solid #444; color: #fff; padding: 4px; font-size: 12px; text-align: right; }
        .input-group input[type="file"] { border:none; background:transparent; width: 100%; font-size:10px; text-align: left;}
        
        /* TOGGLE SWITCHES */
        .toggle-container { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; background: #252526; padding: 8px; border-radius: 4px; border: 1px solid #333; }
        .toggle-switch { position: relative; width: 40px; height: 20px; border-radius: 10px; cursor: pointer; transition: background 0.3s; }
        .toggle-knob { position: absolute; top: 2px; left: 2px; width: 16px; height: 16px; background: #fff; border-radius: 50%; transition: transform 0.3s; box-shadow: 0 1px 3px rgba(0,0,0,0.5); }
        .toggle-switch[data-state="off"] { background: #ff3333; }
        .toggle-switch[data-state="off"] .toggle-knob { transform: translateX(0); }
        .toggle-switch[data-state="pending"] { background: #ffaa00; }
        .toggle-switch[data-state="pending"] .toggle-knob { transform: translateX(10px); }
        .toggle-switch[data-state="on"] { background: #00cc44; }
        .toggle-switch[data-state="on"] .toggle-knob { transform: translateX(20px); }

        .btn { width: 100%; padding: 6px; cursor: pointer; border: none; font-weight: bold; background: #007acc; color: white; margin-top: 5px; font-size: 11px; }
        .btn:hover { background: #0099ff; }
        .btn-nav { background: #444; margin-bottom: 5px; }

        #ssl-panel { display: none; background: #252526; border: 1px dashed #444; padding: 10px; margin-bottom: 10px; }
        .mil-icon { background: transparent; border: none; }
    </style>
</head>
<body>

    <div id="sidebar-left" class="sidebar">
        
        <div class="sidebar-header"><h2>TARGEX</h2><span>Production Control</span></div>

        <div class="section">
            <div class="section-title">System Status</div>
            <div class="status-row"><span>Server Link</span><span class="status-val"><span id="ws-ind" class="indicator red"></span><span id="ws-text">Offline</span></span></div>
            <div class="status-row"><span>Packets RX</span><span class="status-val" id="pkt-count" style="color: #00ff00;">0</span></div>
            <div class="status-row"><span>Active Tracks</span><span class="status-val" id="trk-count" style="color: #fff;">0</span></div>
        </div>

        <div class="section">
            <div class="section-title">Sensor Origin (Cat 34)</div>
            <div class="input-group"><label>Latitude</label><input type="number" step="0.0001" id="sensor-lat" value="0.0000"></div>
            <div class="input-group"><label>Longitude</label><input type="number" step="0.0001" id="sensor-lon" value="0.0000"></div>
            <div style="font-size:10px; color:#666; text-align:right; font-style:italic;" id="origin-status">Waiting for Cat 34...</div>
        </div>

        <div class="sidebar-header" style="border-bottom-color: #ff9900; margin-top: 10px;"><h2 style="color:#ff9900;">CONFIG</h2><span>Network</span></div>
        
        <div class="section">
            <div class="input-group"><label>Input Port (RX)</label><input type="number" id="rx-port" value="8600"></div>
            <button class="btn" onclick="saveNetConfig()">APPLY INPUT SETTINGS</button>

            <div class="divider-title">TAK Output Configuration</div>
            <div id="tak-settings">
                <div class="input-group"><label>CoT IP</label><input type="text" id="cot-ip" value="239.2.3.1"></div>
                <div class="input-group"><label>CoT Port</label><input type="number" id="cot-port" value="6969"></div>
                <div class="input-group">
                    <label>Protocol</label>
                    <div style="display:flex; align-items:center;">
                        <span id="conn-dot" class="indicator green" style="margin-right:8px;" title="Status"></span>
                        <select id="cot-proto" onchange="toggleSSL()">
                            <option value="udp">UDP</option>
                            <option value="tcp">TCP</option>
                            <option value="ssl">SSL</option>
                        </select>
                    </div>
                </div>

                <div id="ssl-panel">
                    <div class="section-title" style="color:#aaa;">Certificates</div>
                    <input type="file" id="ssl-client-cert" style="width:100%; font-size:10px;">
                    <input type="password" id="ssl-client-pass" placeholder="Cert Password" style="width:95%;">
                    <input type="file" id="ssl-trust-store" style="width:100%; font-size:10px; margin-top:5px;">
                    <input type="password" id="ssl-trust-pass" placeholder="Trust Password" style="width:95%;">
                </div>
                <button class="btn" onclick="saveNetConfig()">APPLY TAK SETTINGS</button>
            </div>

            <div style="margin-top:15px;">
                <div class="toggle-container">
                    <span style="font-size:11px; font-weight:bold; color:#ccc;">Output Tracks (TAK)</span>
                    <div id="tgl-tak" class="toggle-switch" data-state="off" onclick="handleToggle('tak')">
                        <div class="toggle-knob"></div>
                    </div>
                </div>
                <div class="toggle-container">
                    <span style="font-size:11px; font-weight:bold; color:#ccc;">Transmit Origin (CoT)</span>
                    <div id="tgl-origin" class="toggle-switch" data-state="off" onclick="handleToggle('origin')">
                        <div class="toggle-knob"></div>
                    </div>
                </div>
            </div>
            
            <div class="divider-title">Asterix Output Configuration</div>
            <div class="input-group"><label>Target IP</label><input type="text" id="ast-ip" value="10.10.10.10"></div>
            <div class="input-group"><label>Target Port</label><input type="number" id="ast-port" value="50010"></div>
            <button class="btn" onclick="saveNetConfig()">APPLY ASTERIX SETTINGS</button>

            <div class="toggle-container" style="margin-top:10px;">
                <span style="font-size:11px; font-weight:bold; color:#ccc;">Forward Asterix</span>
                <div id="tgl-ast" class="toggle-switch" data-state="off" onclick="handleToggle('ast')">
                    <div class="toggle-knob"></div>
                </div>
            </div>
        </div>

        <div style="margin-top:auto; padding:15px; border-top:1px solid #333;">
            <button class="btn btn-nav" onclick="location.href='/asterixLiveLog'">VIEW FULL LIVE LOG</button>
            <button class="btn btn-nav" onclick="location.href='/pcapFilesAndMerge'">OPEN FILE MANAGER</button>
        </div>
    </div>

    <div id="map"></div>

    <script>
        // --- GLOBAL STATE ---
        const ui = {
            wsInd: document.getElementById('ws-ind'), wsText: document.getElementById('ws-text'),
            pktCount: document.getElementById('pkt-count'), trkCount: document.getElementById('trk-count'),
            latInput: document.getElementById('sensor-lat'),
            lonInput: document.getElementById('sensor-lon'), originStatus: document.getElementById('origin-status'),
            tglTak: document.getElementById('tgl-tak'),
            tglOrigin: document.getElementById('tgl-origin'),
            tglAst: document.getElementById('tgl-ast'),
            connDot: document.getElementById('conn-dot')
        };
        const state = { tak: 'off', origin: 'off', ast: 'off', pendingTak: 0 };
        
        let SENSOR_LAT=0.0, SENSOR_LON=0.0;
        let sensorMarker=null;
        let originSet=false;
        let lastSensorUpdate=0; 
        let pktCounter=0;
        const tracks={}; 
        let map;

        function toRad(deg){return deg*Math.PI/180;} function toDeg(rad){return rad*180/Math.PI;}
        
        function computeDestinationPoint(lat, lon, distanceM, bearingDeg) {
            const R = 6371e3; 
            const angDist = distanceM / R;
            const lat1 = toRad(lat);
            const lon1 = toRad(lon);
            const brng = toRad(bearingDeg);

            const lat2 = Math.asin(Math.sin(lat1) * Math.cos(angDist) + 
                                   Math.cos(lat1) * Math.sin(angDist) * Math.cos(brng));
            const lon2 = lon1 + Math.atan2(Math.sin(brng) * Math.sin(angDist) * Math.cos(lat1),
                                           Math.cos(angDist) - Math.sin(lat1) * Math.sin(lat2));
            return [toDeg(lat2), toDeg(lon2)];
        }

        function polarToGeo(rangeNm, azimuthDeg){
            const R=6371e3, rangeM=rangeNm*1852, ad=rangeM/R;
            const lat1=toRad(SENSOR_LAT), lon1=toRad(SENSOR_LON), brng=toRad(azimuthDeg);
            const lat2=Math.asin(Math.sin(lat1)*Math.cos(ad)+Math.cos(lat1)*Math.sin(ad)*Math.cos(brng));
            const lon2=lon1+Math.atan2(Math.sin(brng)*Math.sin(ad)*Math.cos(lat1),Math.cos(ad)-Math.sin(lat1)*Math.sin(lat2));
            return {lat:toDeg(lat2),lon:toDeg(lon2)};
        }

        setTimeout(()=>{if(typeof L!=='undefined'){
            map=L.map('map',{zoomControl:false}).setView([38,-77],5);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{attribution:'Offline',maxZoom:19}).addTo(map);
        }},100);

        function updateSensorMarker(lat,lon){
            if(!map)return; 
            SENSOR_LAT=lat; SENSOR_LON=lon;
            lastSensorUpdate = Date.now();
            ui.latInput.value=lat.toFixed(5); ui.lonInput.value=lon.toFixed(5);
            ui.originStatus.innerText="Origin set via Cat 34"; ui.originStatus.style.color="#00ff00";
            if(sensorMarker)map.removeLayer(sensorMarker);
            sensorMarker=L.circleMarker([lat,lon],{color:'#00ff00',fillColor:'#00ff00',fillOpacity:0.5,radius:6}).bindPopup("Sensor Origin").addTo(map);
            if(!originSet){map.setView([lat,lon],10); originSet=true;}
        }

        async function loadConfig() {
            try {
                const res = await fetch('/api/config');
                if (!res.ok) return;
                const cfg = await res.json();
                if (cfg.rx_port) document.getElementById('rx-port').value = cfg.rx_port;
                if (cfg.cot_ip) document.getElementById('cot-ip').value = cfg.cot_ip;
                if (cfg.cot_port) document.getElementById('cot-port').value = cfg.cot_port;
                if (cfg.cot_protocol) { document.getElementById('cot-proto').value = cfg.cot_protocol; toggleSSL(); }
                if (cfg.asterix_ip) document.getElementById('ast-ip').value = cfg.asterix_ip;
                if (cfg.asterix_port) document.getElementById('ast-port').value = cfg.asterix_port;
                if (cfg.ssl_client_pass) document.getElementById('ssl-client-pass').value = cfg.ssl_client_pass;
                if (cfg.ssl_trust_pass) document.getElementById('ssl-trust-pass').value = cfg.ssl_trust_pass;
                setToggleState('tak', cfg.send_tak_tracks ? 'on' : 'off');
                setToggleState('origin', cfg.send_sensor_pos ? 'on' : 'off');
                setToggleState('ast', cfg.send_asterix ? 'on' : 'off');
            } catch (e) { console.error("Failed to load config:", e); }
        }

        function setToggleState(type, newState) {
            state[type] = newState;
            const el = (type === 'tak') ? ui.tglTak : (type === 'origin') ? ui.tglOrigin : ui.tglAst;
            if(el) el.setAttribute('data-state', newState);
        }

        async function uploadFile(fileInputId) {
            const input = document.getElementById(fileInputId);
            if (input.files.length > 0) {
                const file = input.files[0];
                const buffer = await file.arrayBuffer();
                try {
                    await fetch('/api/upload?name=' + encodeURIComponent(file.name), {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/octet-stream' },
                        body: buffer
                    });
                    return file.name;
                } catch (e) { return null; }
            }
            return null;
        }

        window.saveNetConfig = async (silent = false) => {
            let clientCertName = document.getElementById('ssl-client-cert').files[0]?.name || "";
            let trustStoreName = document.getElementById('ssl-trust-store').files[0]?.name || "";
            if (clientCertName) await uploadFile('ssl-client-cert');
            if (trustStoreName) await uploadFile('ssl-trust-store');

            const cfg = { 
                rx_port: parseInt(document.getElementById('rx-port').value), 
                cot_ip: document.getElementById('cot-ip').value, 
                cot_port: parseInt(document.getElementById('cot-port').value),
                cot_proto: document.getElementById('cot-proto').value,
                ssl_client_pass: document.getElementById('ssl-client-pass').value,
                ssl_trust_pass: document.getElementById('ssl-trust-pass').value,
                ssl_client_cert: clientCertName,
                ssl_trust_store: trustStoreName,
                asterix_ip: document.getElementById('ast-ip').value,
                asterix_port: parseInt(document.getElementById('ast-port').value),
                tak_output_enabled: (state.tak !== 'off'), 
                send_sensor_pos: (state.origin === 'on'),
                asterix_output_enabled: (state.ast === 'on')
            };
            await fetch('/api/config', {method:'POST', body:JSON.stringify(cfg)});
            if(!silent) alert("Configuration Applied!");
        };

        window.handleToggle = (type) => {
            const proto = document.getElementById('cot-proto').value;
            const isTcp = (proto === 'tcp' || proto === 'ssl');
            let newState = (state[type] === 'off') ? 'on' : 'off';
            if (type === 'tak' && newState === 'on' && isTcp) {
                state[type] = 'pending'; state.pendingTak = Date.now();
                ui.tglTak.setAttribute('data-state', 'pending');
            } else {
                state[type] = newState;
                if(type === 'tak') ui.tglTak.setAttribute('data-state', newState);
                if(type === 'origin') ui.tglOrigin.setAttribute('data-state', newState);
                if(type === 'ast') ui.tglAst.setAttribute('data-state', newState);
            }
            saveNetConfig(true); 
        };

        window.toggleSSL = () => {
            const proto = document.getElementById('cot-proto').value;
            document.getElementById('ssl-panel').style.display = (proto === 'ssl') ? 'block' : 'none';
        };

        async function monitorLoop() {
            try {
                const res = await fetch('/api/status');
                if (res.ok) {
                    const status = await res.json();
                    if (state.tak === 'pending') {
                        if (status.tcp_connected) { state.tak = 'on'; ui.tglTak.setAttribute('data-state', 'on'); }
                        else if (Date.now() - state.pendingTak > 5000) { state.tak = 'off'; ui.tglTak.setAttribute('data-state', 'off'); saveNetConfig(true); }
                    } else if (state.tak === 'on' && status.protocol !== 'udp' && !status.tcp_connected) {
                        state.tak = 'off'; ui.tglTak.setAttribute('data-state', 'off'); saveNetConfig(true);
                    }
                }
            } catch(e) {}
            setTimeout(monitorLoop, 1000);
        }

        async function statusLoop() {
            try {
                const res = await fetch('/api/status');
                if (res.ok) {
                    const status = await res.json();
                    if (status.protocol === 'udp') { ui.connDot.className = "indicator green"; ui.connDot.title = "UDP"; }
                    else { ui.connDot.className = status.tcp_connected ? "indicator green" : "indicator red"; ui.connDot.title = status.tcp_connected ? "Connected" : "Disconnected"; }
                }
            } catch(e) {}
            setTimeout(statusLoop, 1000);
        }

        async function dataLoop(){
            try{
                const res=await fetch('/api/data');
                if(res.ok){
                    ui.wsInd.className="indicator green"; ui.wsText.innerText="Online";
                    const packets=await res.json();
                    if(Array.isArray(packets) && packets.length>0){
                        pktCounter+=packets.length;
                        ui.pktCount.innerText=pktCounter.toLocaleString();
                        packets.forEach(p=>processPacket(p));
                    }
                }
            }catch(e){
                ui.wsInd.className="indicator red"; ui.wsText.innerText="Offline";
            }
            setTimeout(dataLoop,100);
        }

        function processPacket(packet){
            if(!packet.layers||!packet.layers.asterix) return; 
            const ast=packet.layers.asterix;
            
            let id=null,lat=null,lon=null,rho=null,theta=null,cat=null;
            let speed=0, heading=0; 
            let vx=null, vy=null; 

            for(const k in ast){
                if(k.includes("000_10_CAT")) cat=parseInt(ast[k]);
                if(k.includes("120_LAT")) lat=parseFloat(ast[k]);
                if(k.includes("120_LON")) lon=parseFloat(ast[k]);
                if(k.includes("040_RHO")) rho=parseFloat(ast[k]);
                if(k.includes("040_THETA")) theta=parseFloat(ast[k]);
                if(k.includes("161_TN")) id=ast[k];
                
                // Speed is likely NM/s (ASTERIX Standard)
                // We convert to M/S for logic (1 NM = 1852 meters)
                if(k.includes("200_GS")) speed = parseFloat(ast[k]) * 1852.0; 
                if(k.includes("200_HDG")) heading = parseFloat(ast[k]); 

                if(k.includes("185_VX") || k.includes("210_VCO")) vx = parseFloat(ast[k]);
                if(k.includes("185_VY") || k.includes("210_VCN")) vy = parseFloat(ast[k]);
            }

            if (speed === 0 && vx !== null && vy !== null) {
                speed = Math.sqrt(vx*vx + vy*vy);
                heading = (Math.atan2(vx, vy) * 180 / Math.PI);
                if(heading < 0) heading += 360;
            }

            if(Array.isArray(id)) id=id[0];
            
            if(lat!==null && lon!==null && (cat===34 || id===null || id==="0")){
                updateSensorMarker(lat,lon);
                return;
            }
            
            if(!originSet && rho!==null) return;
            if(lat===null && rho!==null && theta!==null){
                const g=polarToGeo(rho,theta);
                lat=g.lat; lon=g.lon;
                if(heading === 0) heading = theta; 
            }

            if(lat!==null && lon!==null && id!==null) {
                updateTrack(id, lat, lon, speed, heading);
            }
        }

        function updateTrack(id, lat, lon, speed, heading){
            if(!map||typeof ms==='undefined')return;
            
            const sidc="SUSP-------****", mysymbol=new ms.Symbol(sidc,{size:12,uniqueDesignation:id,colorMode:"Light"});
            const icon=L.divIcon({className:'mil-icon',html:mysymbol.asSVG(),iconAnchor:[mysymbol.getAnchor().x,mysymbol.getAnchor().y]});
            
            // Show Knots in Popup for user friendliness (M/S * 1.9438)
            const speedKts = speed * 1.94384;
            const popupContent = `<b>Track: ${id}</b><br>Spd: ${speedKts.toFixed(1)} kts<br>Hdg: ${heading.toFixed(1)}Â°`;

            if(tracks[id]){
                tracks[id].marker.setLatLng([lat,lon]);
                tracks[id].marker.setIcon(icon);
                tracks[id].marker.getPopup().setContent(popupContent);
                tracks[id].lastUpdate=Date.now();
                
                // Leader Line: Only if speed > 1.0 m/s
                if (speed > 1.0) { 
                    const distMeters = speed * 60; // 60s vector
                    const endPt = computeDestinationPoint(lat, lon, distMeters, heading);
                    
                    if (tracks[id].leader) {
                        tracks[id].leader.setLatLngs([[lat,lon], endPt]);
                    } else {
                        tracks[id].leader = L.polyline([[lat,lon], endPt], {color: '#ffffff', weight: 1, opacity: 0.6}).addTo(map);
                    }
                } else {
                    if (tracks[id].leader) { map.removeLayer(tracks[id].leader); delete tracks[id].leader; }
                }

            } else {
                const m=L.marker([lat,lon],{icon:icon}).addTo(map);
                m.bindPopup(popupContent);
                
                let leader = null;
                if (speed > 1.0) {
                    const distMeters = speed * 60;
                    const endPt = computeDestinationPoint(lat, lon, distMeters, heading);
                    leader = L.polyline([[lat,lon], endPt], {color: '#ffffff', weight: 1, opacity: 0.6}).addTo(map);
                }

                tracks[id]={marker:m, leader:leader, lastUpdate:Date.now()};
            }
        }

        setInterval(()=>{
            const now=Date.now();
            let c=0;
            Object.keys(tracks).forEach(id=>{
                if(now-tracks[id].lastUpdate>5000){
                    if(map) {
                        map.removeLayer(tracks[id].marker);
                        if(tracks[id].leader) map.removeLayer(tracks[id].leader);
                    }
                    delete tracks[id];
                }else c++;
            });
            ui.trkCount.innerText=c;

            if (sensorMarker && (now - lastSensorUpdate > 5000)) {
                map.removeLayer(sensorMarker);
                sensorMarker = null;
                originSet = false;
                ui.originStatus.innerText = "Signal Lost (Timeout)";
                ui.originStatus.style.color = "#ff3333";
            }
        }, 1000);
        
        window.addEventListener('load', () => {
            toggleSSL();
            loadConfig();
        });
        monitorLoop();
        statusLoop();
        dataLoop();
    </script>
</body>
</html>