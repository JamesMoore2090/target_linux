<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TARGEX Live View</title>
    <style>
        /* CSS: Dark Mode "Matrix" Style */
        body { font-family: 'Courier New', monospace; background: #1e1e1e; color: #00ff00; padding: 20px; margin: 0; }
        
        /* Header Container */
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            border-bottom: 2px solid #333;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }

        h1 { margin: 0; font-size: 24px; color: #fff; }

        /* Controls */
        .controls { display: flex; gap: 15px; align-items: center; }
        
        button { 
            cursor: pointer; 
            padding: 8px 16px; 
            font-weight: bold; 
            border: 1px solid #555;
            background: #333; 
            color: #fff;
            transition: all 0.2s;
        }
        button:hover { background: #444; }

        /* Status Light */
        #status-indicator {
            width: 15px; 
            height: 15px; 
            border-radius: 50%; 
            background: #444; /* Default off */
            border: 2px solid #222;
        }

        /* Packet Log Window */
        #packet-log { 
            height: 80vh; 
            overflow-y: scroll; 
            border: 1px solid #444; 
            padding: 10px; 
            background: #000; 
            font-size: 14px;
        }
        
        /* Individual Log Lines */
        .packet { border-bottom: 1px solid #333; padding: 2px 0; display: flex; }
        .ts { color: #888; margin-right: 10px; width: 140px; flex-shrink: 0; }
        .data { color: #0f0; }

        #processing-modal {
        display: none; /* Hidden by default */
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.8);
        align-items: center;
        justify-content: center;
        flex-direction: column;
    }
    .spinner {
        border: 8px solid #f3f3f3;
        border-top: 8px solid #00ff00; /* Neon Green */
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>



    <div class="header">
        <h1>TARGEX TACTICAL INTERFACE</h1>
        
        <div class="controls">
            <div id="status-indicator" title="Capture Status"></div>
            
            <button id="toggle-btn" onclick="toggleCapture()">Initializing...</button>
            
            <button onclick="location.href='/files.html'">File Manager</button>
            <button onclick="location.href='/settings.html'">Settings</button>
        </div>
    </div>

    <div id="packet-log">
        <div class="packet"><span class="ts">[SYSTEM]</span><span class="data">Waiting for data stream...</span></div>
    </div>

    <script>
        // --- 1. THE CONFIGURATION MAP ---
    // This matches the JSON structure you provided
    const ASTERIX_MAP = {
        "CAT_34": [
            // Standard Keys from your log
            { key: "asterix_asterix_category", label: "CAT" },
            { key: "asterix_asterix_SAC", label: "SAC" },
            { key: "asterix_asterix_SIC", label: "SIC" },
            { key: "asterix_asterix_TOD", label: "Time" },
            
            
            // 034 Specifics (Underscores instead of dots)
            { key: "asterix_asterix_034_000_MT", label: "MsgType" },
            { key: "asterix_asterix_034_050_02_ANT", label: "Antenna" },
            { key: "asterix_asterix_034_050_02_CHAB", label: "ChAB" },
            { key: "asterix_asterix_034_050_02_OVL", label: "OVL" },
            { key: "asterix_asterix_034_050_02_MSC", label: "MSC" },
            { key: "asterix_asterix_034_060_02_POL", label: "POL" },
            { key: "asterix_asterix_034_060_02_RED_RAD", label: "RedRad" },
            { key: "asterix_asterix_034_060_02_STC", label: "STC" },
            { key: "asterix_asterix_034_120_H", label: "Height" },
            { key: "asterix_asterix_034_120_LAT", label: "Lat" },
            { key: "asterix_asterix_034_120_LON", label: "Lon" }
        ],
        "CAT_48": [
            // Assuming similar pattern for Cat 48 (Tshark usually follows suit)
            { key: "asterix_asterix_category", label: "CAT" },
            { key: "asterix_asterix_048_161_TN", label: "Track#" },
            { key: "asterix_asterix_SAC", label: "SAC" },
            { key: "asterix_asterix_SIC", label: "SIC" },
            { key: "asterix_asterix_TOD", label: "Time" },
            
            { key: "asterix_asterix_048_020_TYP", label: "Type" },
            { key: "asterix_asterix_048_020_SIM", label: "SIM" },
            { key: "asterix_asterix_048_020_RDP", label: "RDP" },
            { key: "asterix_asterix_048_020_SPI", label: "SPI" },
            { key: "asterix_asterix_048_040_RHO", label: "Rho" },
            { key: "asterix_asterix_048_040_THETA", label: "Theta" },
            
            { key: "asterix_asterix_048_042_X", label: "X" },
            { key: "asterix_asterix_048_042_Y", label: "Y" },
            { key: "asterix_asterix_048_200_GSP", label: "GroundSpeed" },
            { key: "asterix_asterix_048_200_HDG", label: "Heading" },
            { key: "asterix_asterix_048_170_CNF", label: "Confirmed" },
            { key: "asterix_asterix_048_170_RAD", label: "Radar" },
            { key: "asterix_asterix_048_170_DOU", label: "DOU" },
            { key: "asterix_asterix_048_170_MAH", label: "MAH" },
            { key: "asterix_asterix_048_170_CDM", label: "CDM" },
            { key: "asterix_asterix_048_210_SIGX", label: "Sig X" },
            { key: "asterix_asterix_048_210_SIGY", label: "Sig Y" },
            { key: "asterix_asterix_048_210_SIGV", label: "Sig V" },
            { key: "asterix_asterix_048_210_SIGH", label: "Sig H" }
        ]
    };

    // --- 2. WEBSOCKET SETUP ---
    const logDiv = document.getElementById('packet-log');
    const socket = new WebSocket("ws://" + window.location.host + "/ws");

    socket.onopen = () => {
        addLog("SYSTEM", "Connected to TARGEX Core.", "#00ff00");
    };

    socket.onmessage = (event) => {
        try {
            const packet = JSON.parse(event.data);
            if (packet.index) return; // Ignore Tshark metadata

            // --- DECODE LOGIC ---
            let summary = "";
            let style = "";
            let sourceLabel = "UNK";

            // 1. Get Base IP Info
            let srcIP = "Unknown";
            let dstIP = "Unknown";
            let port = "Unknown";

            if (packet.layers && packet.layers.ip) {
                srcIP = packet.layers.ip.ip_ip_src;
                dstIP = packet.layers.ip.ip_ip_dst;
            }
            if (packet.layers && packet.layers.udp) {
                port = packet.layers.udp.udp_udp_dstport;
            }

            // 2. Check for ASTERIX Data
            const asterixData = packet.layers ? packet.layers.asterix : null;

            if (asterixData) {
                // DETECT CATEGORY DIRECTLY
                // Your log shows: asterix_asterix_category: "34"
                const catID = asterixData.asterix_asterix_category; 

                // Helper to build string based on the map
                const parseCat = (map) => {
                    let dataStr = "";
                    map.forEach(field => {
                        const val = asterixData[field.key];
                        // Only show fields that actually exist in this packet
                        if (val !== undefined && val !== null) {
                            dataStr += `${field.label}:${val} | `;
                        }
                    });
                    return dataStr;
                };

                if (catID === "34" || catID === 34) {
                    sourceLabel = "CAT 34";
                    style = "color: orange;";
                    summary = parseCat(ASTERIX_MAP.CAT_34);
                } 
                else if (catID === "48" || catID === 48) {
                    sourceLabel = "CAT 48";
                    style = "color: cyan;";
                    summary = parseCat(ASTERIX_MAP.CAT_48);
                } 
                else {
                    sourceLabel = "ASTERIX";
                    summary = "Unknown Cat: " + catID;
                    console.log("UNMAPPED CAT:", asterixData);
                }
            } else {
                // Fallback for non-asterix traffic
                sourceLabel = "IP/UDP";
                summary = `SRC: ${srcIP} -> DST: ${dstIP} : ${port}`;
            }

            // Prepend IP info to ASTERIX data if space permits
            if(sourceLabel.includes("CAT")) {
                summary = `[${srcIP}:${port}] ` + summary;
            }

            addLog(sourceLabel, summary, style);

        } catch(e) {
            console.error(e);
        }
    };

    function addLog(source, text, style = "") {
        const logDiv = document.getElementById('packet-log');

        // 1. SMART SCROLL CHECK
        // We check if the user is near the bottom BEFORE adding the new element.
        // We use a 50px tolerance so it feels natural even if not pixel-perfect.
        const tolerance = 50;
        const isAtBottom = (logDiv.scrollHeight - logDiv.scrollTop - logDiv.clientHeight) < tolerance;

        // 2. CREATE ELEMENT
        const div = document.createElement('div');
        div.className = 'packet';
        const time = new Date().toLocaleTimeString();
        
        div.innerHTML = `
            <span class="ts">[${time}] <br/> ${source}</span>
            <span class="data" style="${style}">${text}</span>
        `;
        
        logDiv.appendChild(div);
        
        // 3. CONDITIONAL SCROLL
        // Only force scroll down if the user was already at the bottom.
        if (isAtBottom) {
            logDiv.scrollTop = logDiv.scrollHeight;
        }
    }

        socket.onclose = () => {
            console.log("Connection lost.");
            // Optional: Auto-reconnect logic could go here
        };
        
        // --- Status Loop (Keep your existing updateStatus logic here) ---
        async function updateStatus() {
            try {
                const res = await fetch('/api/capture/status');
                const data = await res.json();
                const btn = document.getElementById('toggle-btn');
                const ind = document.getElementById('status-indicator');

                if (data.running) {
                    btn.textContent = "STOP CAPTURE";
                    btn.style.background = "darkred";
                    ind.style.background = "#00ff00"; 
                    ind.style.boxShadow = "0 0 10px #00ff00";
                } else {
                    btn.textContent = "START CAPTURE";
                    btn.style.background = "darkgreen";
                    ind.style.background = "red"; 
                    ind.style.boxShadow = "none";
                }
            } catch(e) {}
        }

        async function toggleCapture() {
            const btn = document.getElementById('toggle-btn');
            const isRunning = btn.textContent.includes("STOP");
            await fetch('/api/capture/control', {
                method: 'POST',
                body: JSON.stringify({ action: !isRunning })
            });
            setTimeout(updateStatus, 500);
        }

        setInterval(updateStatus, 2000);
        updateStatus();
    </script>
</body>
</html>