<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TARGEX Tactical Display</title>
    
    <link rel="stylesheet" href="/libs/leaflet.css" />
    <script src="/libs/leaflet.js"></script>
    <script src="/libs/milsymbol.js"></script>

    <style>
        body { margin: 0; padding: 0; background: #111; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; display: flex; height: 100vh; }
        
        /* --- SIDEBAR --- */
        #sidebar {
            width: 300px; min-width: 300px;
            background: #1e1e1e; border-right: 1px solid #333;
            color: #ccc; display: flex; flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,0.5); z-index: 1000;
        }

        .sidebar-header { padding: 15px; background: #252526; border-bottom: 2px solid #007acc; }
        .sidebar-header h2 { margin: 0; color: #00ff00; font-size: 20px; letter-spacing: 1px; }
        .sidebar-header span { font-size: 10px; color: #888; }

        .section { padding: 15px; border-bottom: 1px solid #333; }
        .section-title { font-size: 11px; font-weight: bold; color: #007acc; margin-bottom: 10px; text-transform: uppercase; }

        /* Status Indicators */
        .status-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; }
        .status-val { font-family: monospace; color: #fff; }
        .indicator { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 5px; }
        
        .green { background: #00ff00; box-shadow: 0 0 5px #00ff00; }
        .red { background: #ff0000; box-shadow: 0 0 5px #ff0000; }
        .yellow { background: #ffff00; }

        /* Form Elements */
        .input-group { margin-bottom: 10px; }
        .input-group label { display: block; font-size: 11px; color: #888; margin-bottom: 3px; }
        .input-group input, .input-group select { 
            width: 95%; background: #333; border: 1px solid #444; 
            color: #fff; padding: 5px; font-size: 12px; 
        }
        
        /* Hidden Password Fields */
        .pwd-field { display: none; margin-top: 5px; border-left: 2px solid #007acc; padding-left: 5px; }
        .pwd-field input { border: 1px solid #555; background: #222; color: #fff; }

        .btn { 
            width: 100%; padding: 8px; cursor: pointer; border: none; 
            font-weight: bold; background: #007acc; color: white; margin-top: 5px;
        }
        .btn:hover { background: #0099ff; }
        .btn-nav { background: #444; margin-top: 5px; }

        /* --- MAP AREA --- */
        #map { 
            flex-grow: 1; height: 100%; background: #000;
            position: relative; z-index: 1;
        }
        .mil-icon { background: transparent; border: none; }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="sidebar-header">
            <h2>TARGEX</h2>
            <span>TACTICAL DISPLAY SYSTEM</span>
        </div>

        <div class="section">
            <div class="section-title">System Status</div>
            <div class="status-row">
                <span>Web Server</span>
                <span class="status-val"><span id="ws-ind" class="indicator red"></span><span id="ws-text">Offline</span></span>
            </div>
            <div class="status-row">
                <span>Rx Packets</span>
                <span class="status-val" id="pkt-count" style="color: #00ff00;">0</span>
            </div>
             <div class="status-row">
                <span>Active Tracks</span>
                <span class="status-val" id="trk-count">0</span>
            </div>
        </div>

        <div class="section">
            <div class="section-title">Network Configuration</div>
            
            <div class="input-group">
                <label>ASTERIX RX PORT</label>
                <input type="number" id="rx-port" value="8600">
            </div>

            <div class="input-group">
                <label>CoT DESTINATION IP</label>
                <input type="text" id="cot-ip" value="10.10.10.50"> </div>

            <div class="input-group">
                <label>CoT PORT</label>
                <input type="number" id="cot-port" value="8089"> </div>

            <div class="status-row">
                <span>CoT Link Status</span>
                <span class="status-val">
                    <span id="cot-ind" class="indicator yellow"></span>
                    <span id="cot-text">UDP/Ready</span>
                </span>
            </div>
        </div>

        <div class="section">
            <div class="section-title">TAK SSL Integration</div>
            
            <div class="input-group">
                <label>Protocol</label>
                <select id="cot-proto" onchange="toggleSSL()">
                    <option value="udp">UDP (Broadcast)</option>
                    <option value="tcp">TCP (Unsecured)</option>
                    <option value="ssl">SSL (TAK Server)</option>
                </select>
            </div>

            <div id="ssl-panel" style="display:none; border: 1px dashed #444; padding: 8px;">
                
                <div class="input-group">
                    <label>Client Identity (.p12)</label>
                    <input type="file" id="client-p12" accept=".p12" onchange="showPwd('client-pwd-group')">
                    <div id="client-pwd-group" class="pwd-field">
                        <label>Password:</label>
                        <input type="password" id="client-pwd" placeholder="Enter P12 Password">
                    </div>
                </div>

                <div class="input-group">
                    <label>Trust Store / CA (.p12)</label>
                    <input type="file" id="trust-p12" accept=".p12" onchange="showPwd('trust-pwd-group')">
                    <div id="trust-pwd-group" class="pwd-field">
                        <label>Password:</label>
                        <input type="password" id="trust-pwd" placeholder="Enter CA Password">
                    </div>
                </div>

            </div>

            <button class="btn" onclick="applyConfig()">APPLY CONFIGURATION</button>
        </div>

        <div class="section" style="border:none;">
            <button class="btn btn-nav" onclick="location.href='/log'">VIEW LIVE LOG</button>
            <button class="btn btn-nav" onclick="location.href='/files'">FILE MANAGER</button>
        </div>
    </div>

    <div id="map"></div>

    <script>
        // --- MAP INIT ---
        let map;
        try {
            if (typeof L === 'undefined') throw new Error("Leaflet Lib Missing");
            map = L.map('map', { zoomControl: false }).setView([0, 0], 2);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: 'Offline/Dark', maxZoom: 19
            }).addTo(map);
            setTimeout(() => { map.invalidateSize(); }, 100);
        } catch(e) { alert("Map Library Missing!"); }

        // --- STATE ---
        const tracks = {}; 
        let pktCounter = 0;
        let hasCentered = false; 
        let SENSOR_LAT = 38.5134; 
        let SENSOR_LON = -77.3008;

        // --- UI REFS ---
        const ui = {
            wsInd: document.getElementById('ws-ind'),
            wsText: document.getElementById('ws-text'),
            cotInd: document.getElementById('cot-ind'),
            cotText: document.getElementById('cot-text'),
            pktCount: document.getElementById('pkt-count'),
            trkCount: document.getElementById('trk-count'),
            sslPanel: document.getElementById('ssl-panel')
        };

        // --- WEBSOCKET ---
        const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
        const socket = new WebSocket(`${protocol}://${window.location.host}/ws`);

        socket.onopen = () => {
            ui.wsInd.className = "indicator green";
            ui.wsText.textContent = "Online";
        };

        socket.onclose = () => {
            ui.wsInd.className = "indicator red";
            ui.wsText.textContent = "Disconnected";
        };

        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            
            // 1. Check for Status Update (Backend Feedback)
            if (data.type === 'ssl_status') {
                updateCoTStatus(data.status); // "connected", "failed", "connecting"
                return;
            }

            // 2. Normal Data Packet
            pktCounter++;
            ui.pktCount.textContent = pktCounter.toLocaleString();
            processPacket(data);
        };

        // --- UI LOGIC ---
        function toggleSSL() {
            const proto = document.getElementById('cot-proto').value;
            ui.sslPanel.style.display = (proto === 'ssl') ? 'block' : 'none';
            
            // Reset status text immediately on toggle
            if (proto === 'ssl') {
                updateCoTStatus("ready");
            } else {
                ui.cotInd.className = "indicator yellow";
                ui.cotText.textContent = "UDP/Ready";
            }
        }

        function showPwd(elementId) {
            document.getElementById(elementId).style.display = "block";
        }

        function updateCoTStatus(status) {
            if (status === 'connected') {
                ui.cotInd.className = "indicator green";
                ui.cotText.textContent = "SSL/Connected";
            } else if (status === 'failed') {
                ui.cotInd.className = "indicator red";
                ui.cotText.textContent = "SSL/Failed";
            } else if (status === 'connecting') {
                ui.cotInd.className = "indicator yellow";
                ui.cotText.textContent = "SSL/Connecting...";
            } else {
                ui.cotInd.className = "indicator yellow";
                ui.cotText.textContent = "SSL/Ready";
            }
        }

        // --- CONFIG SUBMISSION ---
        async function applyConfig() {
            const proto = document.getElementById('cot-proto').value;
            
            // 1. Basic Config
            const config = {
                rx_port: parseInt(document.getElementById('rx-port').value),
                cot_ip: document.getElementById('cot-ip').value,
                cot_port: parseInt(document.getElementById('cot-port').value),
                cot_proto: proto
            };

            // Set UI to "Connecting..." immediately if SSL
            if (proto === 'ssl') updateCoTStatus("connecting");

            try {
                // Send JSON Config First
                await fetch('/api/config', { method: 'POST', body: JSON.stringify(config) });

                // 2. Handle SSL Files (Only if SSL is selected)
                if (proto === 'ssl') {
                    const formData = new FormData();
                    
                    const clientFile = document.getElementById('client-p12').files[0];
                    const clientPwd = document.getElementById('client-pwd').value;
                    const trustFile = document.getElementById('trust-p12').files[0];
                    const trustPwd = document.getElementById('trust-pwd').value;

                    if (!clientFile || !trustFile) {
                        alert("Please select both Client and Trust Store .p12 files.");
                        updateCoTStatus("failed");
                        return;
                    }

                    // Append files and passwords
                    formData.append('client_p12', clientFile);
                    formData.append('client_pwd', clientPwd);
                    formData.append('trust_p12', trustFile);
                    formData.append('trust_pwd', trustPwd);

                    const res = await fetch('/api/upload_ssl', { method: 'POST', body: formData });
                    
                    if (res.ok) {
                        // Backend should now trigger the connection attempt
                        // We wait for the WebSocket 'ssl_status' message to turn it green
                        console.log("SSL Config Sent. Waiting for connection...");
                    } else {
                        throw new Error("Upload Failed");
                    }
                } else {
                    alert("UDP Configuration Applied!");
                }

            } catch(e) { 
                alert("Configuration Error: " + e.message);
                if (proto === 'ssl') updateCoTStatus("failed");
            }
        }

        // --- PACKET LOGIC ---
        function getFloat(val) {
            if (!val) return null;
            if (Array.isArray(val)) return parseFloat(val[0]);
            return parseFloat(val);
        }

        function processPacket(packet) {
            if (!packet.layers || !packet.layers.asterix) return;
            const ast = packet.layers.asterix;
            
            let trackId = ast.asterix_asterix_048_161_TN || ast.asterix_048_161_TN || 
                          ast.asterix_asterix_034_161_TN || ast.asterix_034_161_TN || "UNK";
            if (Array.isArray(trackId)) trackId = trackId[0];

            let lat = null, lon = null;
            const rawLat34 = ast.asterix_asterix_034_120_LAT || ast.asterix_034_120_LAT;
            const rawLon34 = ast.asterix_asterix_034_120_LON || ast.asterix_034_120_LON;

            if (rawLat34 && rawLon34) {
                lat = getFloat(rawLat34);
                lon = getFloat(rawLon34);
            } else {
                const rho = getFloat(ast.asterix_asterix_048_040_RHO || ast.asterix_048_040_RHO);
                const theta = getFloat(ast.asterix_asterix_048_040_THETA || ast.asterix_048_040_THETA);
                if (rho !== null && theta !== null) {
                    const coords = calculateLatLon(SENSOR_LAT, SENSOR_LON, rho, theta);
                    lat = coords.lat;
                    lon = coords.lon;
                }
            }

            if (lat !== null && lon !== null && !isNaN(lat)) {
                if (!hasCentered && map) { map.setView([lat, lon], 10); hasCentered = true; }
                updateTrack(trackId, lat, lon);
            }
        }

        function calculateLatLon(lat1, lon1, rangeNM, bearingDeg) {
            const R = 3440.065; 
            const radLat1 = lat1 * (Math.PI / 180);
            const radLon1 = lon1 * (Math.PI / 180);
            const radBearing = bearingDeg * (Math.PI / 180);
            const angularDist = rangeNM / R;
            const radLat2 = Math.asin(Math.sin(radLat1) * Math.cos(angularDist) + Math.cos(radLat1) * Math.sin(angularDist) * Math.cos(radBearing));
            const radLon2 = radLon1 + Math.atan2(Math.sin(radBearing) * Math.sin(angularDist) * Math.cos(radLat1), Math.cos(angularDist) - Math.sin(radLat1) * Math.sin(radLat2));
            return { lat: radLat2 * (180 / Math.PI), lon: radLon2 * (180 / Math.PI) };
        }

        // Dropout Logic (5 sec)
        setInterval(() => {
            const now = Date.now();
            let count = 0;
            Object.keys(tracks).forEach(id => {
                if (now - tracks[id].lastUpdate > 5000) {
                    if (map) map.removeLayer(tracks[id].marker);
                    delete tracks[id];
                } else { count++; }
            });
            ui.trkCount.textContent = count;
        }, 1000);

        function updateTrack(id, lat, lon) {
            if (!map || typeof ms === 'undefined') return;
            const numLat = Number(lat);
            const numLon = Number(lon);
            if (isNaN(numLat)) return;

            // S = Standard, U = Unknown, S = Surface (Sea), P = Present
            const sidc = `SUSP-------****`; 

            const mysymbol = new ms.Symbol(sidc, { size: 30, uniqueDesignation: id, colorMode: "Light" });
            const icon = L.divIcon({ className: 'mil-icon', html: mysymbol.asSVG(), iconAnchor: [mysymbol.getAnchor().x, mysymbol.getAnchor().y] });

            if (tracks[id]) {
                tracks[id].marker.setLatLng([numLat, numLon]);
                tracks[id].marker.setIcon(icon);
                tracks[id].lastUpdate = Date.now();
            } else {
                const marker = L.marker([numLat, numLon], {icon: icon}).addTo(map);
                marker.bindPopup(`<b>Track: ${id}</b><br>Lat: ${numLat.toFixed(4)}<br>Lon: ${numLon.toFixed(4)}`);
                tracks[id] = { marker: marker, lastUpdate: Date.now() };
            }
        }
    </script>
</body>
</html>